#!/usr/bin/env python
# encoding: utf-8
'''
@author: Miao Feng
@contact: skaudreymia@gmail.com
@software: PyCharm
@file: plot.py
@time: 2020/12/3 12:56
@desc:
'''
import numpy as np
import cv2
import matplotlib
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import axes3d
from matplotlib.animation import FuncAnimation

matplotlib.use('Qt5Agg') # for pycharm show FuncAnimation directly
def plotkp(image,joints_list,box_list,joints_test):
    '''
    Joints = [RFoot,
    :param image: (B,G,R)
    :param coords: 16*2, (x,y)
    :return:
    '''
    LINKS = [(0,1),(1,2),(2,6),(6,3),(3,4),(4,5),(6,7),(7,13),(13,14),(14,15),(7,12),(12,11),(11,10),(7,8),(8,9)]
    color = [(241, 242, 224), (196, 203, 128), (136, 150, 0), (64, 77, 0),
             (201, 230, 200), (132, 199, 129), (71, 160, 67), (32, 94, 27),
             (130, 224, 255), (7, 193, 255), (0, 160, 255), (0, 111, 255),
             (220, 216, 207), (174, 164, 144), (139, 125, 96), (100, 90, 69),
             (252, 229, 179), (247, 195, 79), (229, 155, 3), (155, 87, 1),
             (231, 190, 225), (200, 104, 186), (176, 39, 156), (162, 31, 123),
             (210, 205, 255), (115, 115, 229), (80, 83, 239), (40, 40, 198)]
    color_name = ['teal01', 'teal02', 'teal03', 'teal04',
                       'green01', 'green02', 'green03', 'green04',
                       'amber01', 'amber02', 'amber03', 'amber04',
                       'bluegrey01', 'bluegrey02', 'bluegrey03', 'bluegrey04',
                       'lightblue01', 'lightblue02', 'lightblue03', 'lightblue04',
                       'purple01', 'purple02', 'purple03', 'purple04',
                       'red01', 'red02', 'red03', 'red04']

    links = []
    color_id = [1, 2, 3, 3, 2, 1, 5, 27, 26, 25, 27, 26, 25,4,6]
    palette = {}
    for i, name in enumerate(color_name):
        palette[name] = color[i]

    for i in range(len(LINKS)):
        links.append({'link': LINKS[i], 'color': palette[color_name[color_id[i]]]})

    point_size = 5
    point_color = (10, 128, 255)  # BGR
    thickness = 4  # 0 、4、8
    # id_plot = 15
    if joints_test is not None:
        for joints in joints_test:
            for idx,coor in enumerate(joints):
                # if idx==id_plot:
                cv2.circle(image, (int(coor[0]), int(coor[1])), point_size, (255,0,0), thickness)

    # add joints

    for joints in joints_list:
        for idx,coor in enumerate(joints):
            # if idx==id_plot:
            cv2.circle(image, (int(coor[0]), int(coor[1])), point_size, point_color, thickness+1)


    # plot links: skeletons
    for joints in joints_list:
        for i in range(len(links)):
            l = links[i]['link']
            good_link = True
            for p in l:
                if np.array_equal(joints[p], [-1, -1]):
                    good_link = False
            if good_link:
                pos = (joints[l[0]].astype(np.int),joints[l[1]].astype(np.int))
                cv2.line(image, tuple(pos[0]), tuple(pos[1]), links[i]['color'][::-1], thickness=5)

    # print bounding box
    color_rect = color[-5]
    if box_list is not None:
        for box in box_list:
            cv2.rectangle(image, (round(box[0]), round(box[1])), (round(box[0] + box[2]), round(box[1] + box[3])), color_rect, 2)

    window_name = '2d pose'

    cv2.imshow(window_name, image)

    cv2.waitKey(0)

    cv2.destroyAllWindows()

def givePixel(link, joints):
    """ Returns the pixel corresponding to a link
    Args:
        link 	: (int-tuple) Tuple of linked joints
        joints	: (array) Array of joints position shape = outDim x 2
    Returns:
        out		: (tuple) Tuple of joints position
    """
    return (joints[link[0]].astype(np.int), joints[link[1]].astype(np.int))


def plot3dPose(pose_dict,title='all'):
    '''
    Plot 3d pose:
    https://segmentfault.com/a/1190000020133415
    There may be multiple people in one image
    :param pose_dict: pose_dict,
    :return:
    '''
    # ['RHip', 'RKnee', 'RFoot', 'LHip', 'LKnee', 'LFoot', 'Spine', 'Thorax', 'Neck',
    #  'Head', 'LShoulder', 'LElbow', 'LWrist', 'RShoulder', 'RElbow', 'RWrist']
    nj,npeople,nz = len(pose_dict),len(pose_dict['Head']),len(pose_dict['Head'][0])
    hip = np.zeros((npeople,nz))
    for (idx,(lh,rh)) in enumerate(zip(pose_dict['LHip'],pose_dict['RHip'])):
        hip[idx,:] = (np.array(lh)+np.array(rh))/2

    nj += 1

    # hip = np.array(pose_dict['LHip']+pose_dict['RHip']).mean(axis=1)
    pose_dict['Hip'] = hip.tolist()
    H36M_dict = {'RHip':0, 'RKnee':1, 'RFoot':2, 'LHip':3, 'LKnee':4, 'LFoot':5,'Spine':6, 'Thorax':7,'Neck':8,
                'Head':9, 'LShoulder':10, 'LElbow':11, 'LWrist':12, 'RShoulder':13, 'RElbow':14, 'RWrist':15,'Hip':16}
    skeletonMap = [
        ['RWrist','RElbow'],
        ['RElbow','RShoulder'],
        ['RShoulder','Thorax'],
        ['LWrist','LElbow'],
        ['LElbow','LShoulder'],
        ['LShoulder','Thorax'],
        ['RShoulder','RElbow'],
        ['RFoot','RKnee'],
        ['RKnee','RHip'],
        ['RHip','Hip'],
        ['LFoot', 'LKnee'],
        ['LKnee', 'LHip'],
        ['LHip', 'Hip'],
        ['Head','Neck'],
        ['Neck','Thorax'],
        ['Thorax','Spine'],
        ['Spine', 'Hip'],
    ]
    joints_tmp = np.array(list(pose_dict.values())) # shape = (17,#person,3)
    # nj,npeople,nz = joints_tmp.shape
    joints = np.zeros((npeople,nj,nz))
    for i in range(nj):
        for j in range(npeople):
            joints[j,i,:] = joints_tmp[i,j,:]

    def rotate(pose_3d,axis='x',angle = np.pi):
        # do rotation around one axis in 180 angle
        c,s = np.cos(angle),np.sin(angle)
        r_x = np.array([[1,0,0],[0,c,-s],[0,s,c]])
        r_y = np.array([[c,0,s],[0,1,0],[-s,0,c]])
        r_z = np.array([[c,-s,0],[s,c,0],[0,0,1]])
        if axis=='x':
            return np.dot(pose_3d,r_x)
        elif axis =='y':
            return np.dot(pose_3d,r_y)
        elif axis == 'z':
            return np.dot(pose_3d, r_z)

    # do rotation so that head is upward
    joints = rotate(joints, 'z', np.pi/2)
    joints = rotate(joints,'x', -np.pi)
    joints = rotate(joints, 'y', -np.pi/2)
    joints = rotate(joints, 'z', np.pi / 2)

    nlim_high = np.ceil(np.max(joints))
    nlim_low = np.floor(np.min(joints))
    print(nlim_high,' ',nlim_low)



    def init():
        ax.set_xlabel('x')
        ax.set_ylabel('z')
        ax.set_zlabel('y')
        ax.set_ylim(nlim_low,nlim_high)
        ax.set_xlim(nlim_low, nlim_high)
        ax.set_zlim(nlim_low, nlim_high)

    fig = plt.figure()
    ax = fig.add_subplot(111,projection='3d')
    init()

    def update(index):
        ax.lines = []
        ax.collections = []

        for idx,bone in enumerate(skeletonMap):
            if None in bone:
                continue
            else:
                endpt1 = H36M_dict[bone[0]]
                endpt2 = H36M_dict[bone[1]]
                endpt_x = [joints[index,endpt1,0],joints[index,endpt2,0]]
                endpt_y = [joints[index,endpt1,1],joints[index,endpt2,1]]
                endpt_z = [joints[index,endpt1,2],joints[index,endpt2,2]]
                ax.plot(endpt_x,endpt_y,endpt_z,c='r')
        ax.scatter(joints[index,:,0],joints[index,:,1],joints[index,:,2],c='b',marker='.')

    ani = FuncAnimation(fig,update,frames=joints.shape[0],interval=100,repeat=False)
    # ani.save(savename, writer='imagemagick', fps=60) # Here when I try to solve it collapsed, it's becasue the installed imagemagick
    # plt.title(title)
    plt.show()





if __name__=='__main__':
    # pose_dict = {
    #     'RHip' :  [[-124.85454163, -4.29534546,-53.35546257]],
    #     'RKnee' :  [[-169.74940111,  120.62122072, -2.79028358]],
    #     'RFoot' :  [[-240.99544836,  169.94816258, 110.73207917]],
    #     'LHip' :  [[124.85477051,    4.29543567,   53.35558182]],
    #     'LKnee' :  [[111.13859558,  138.34493173,  106.831009]],
    #     'LFoot' :  [[50.35375361,  171.58538792,  231.45533125]],
    #     'Spine' :  [[14.66536921, -36.81361756, -14.08926448]],
    #     'Thorax' :  [[35.37541618, -54.51350527, -27.01870406]],
    #     'Neck' :  [[61.06527245, -87.0445221, -97.11109839]],
    #     'Head' :  [[50.04854082, -110.50480031, -63.81849714]],
    #     'LShoulder' :  [[200.48571318, -114.69882592 ,  67.16488506]],
    #     'LElbow' :  [[463.55943259, - 259.64689638,  176.07268786]],
    #     'LWrist' :  [[710.38944826, -301.01008928 , 151.53798474]],
    #     'RShoulder' :  [[-150.91100588, -94.83159329, -97.09003865]],
    #     'RElbow' :  [[-436.41092699, -227.78084447, -235.02287427]],
    #     'RWrist' :  [[-622.51938238, -218.2379575, -398.38430061]]
    # }

    # pose_dict = {'RHip': [[-1.5913496017456055, -0.33488965034484863, -0.37189143896102905]], 'RKnee': [[-1.0333143472671509, 0.5714141130447388, -0.29859459400177]], 'RFoot': [[-1.4612505435943604, 0.34498369693756104, 0.3262362480163574]], 'LHip': [[1.5913453102111816, 0.33488863706588745, 0.3718889355659485]], 'LKnee': [[0.5438726544380188, 0.505325436592102, 0.3648742437362671]], 'LFoot': [[0.03677966073155403, 0.4366190731525421, 0.99739009141922]], 'Spine': [[0.3520374000072479, -0.8685669302940369, -0.20849531888961792]], 'Thorax': [[0.4757487177848816, -0.5561017394065857, -0.6076706051826477]], 'Neck': [[0.4956667125225067, -0.32209306955337524, -1.0841253995895386]], 'Head': [[0.5907641649246216, -0.4790101647377014, -1.1553949117660522]], 'LShoulder': [[1.6922301054000854, -0.7704015374183655, -0.05355587229132652]], 'LElbow': [[2.7291576862335205, -1.3925609588623047, 0.19512802362442017]], 'LWrist': [[3.715212106704712, -0.4755743741989136, -0.3313710689544678]], 'RShoulder': [[-0.8902084231376648, -1.0681300163269043, -0.5226490497589111]], 'RElbow': [[-1.7252826690673828, -1.4186623096466064, -0.35157695412635803]], 'RWrist': [[-2.3140554428100586, -0.5129520297050476, -0.4597843885421753]]}
    # pose_dict = {'RHip': [[-0.8003283143043518, -0.36267486214637756, -0.19569344818592072]], 'RKnee': [[-1.0322239398956299, -0.2126920074224472, -0.023653779178857803]], 'RFoot': [[-0.4232049882411957, -0.05147683247923851, 0.1749281883239746]], 'LHip': [[0.5549529790878296, 0.46233710646629333, -0.08662816882133484]], 'LKnee': [[0.7953065633773804, 0.16934552788734436, -0.26539483666419983]], 'LFoot': [[0.38451939821243286, -0.42141252756118774, 0.2893464267253876]], 'Spine': [[-0.3523995280265808, -0.7073802947998047, 0.8420525789260864]], 'Thorax': [[-0.24415510892868042, -0.4950583577156067, 0.8184247612953186]], 'Neck': [[-0.3290875554084778, 0.12101341038942337, 0.043865006417036057]], 'Head': [[-0.10921024531126022, -0.15629243850708008, 0.5627151131629944]], 'LShoulder': [[0.8679566979408264, -0.4752282202243805, 0.34501591324806213]], 'LElbow': [[1.0209684371948242, -0.4260888695716858, -0.3152851462364197]], 'LWrist': [[0.6251082420349121, 0.0701918676495552, -0.5825281143188477]], 'RShoulder': [[-0.7755376696586609, -0.9350218772888184, 0.2503373622894287]], 'RElbow': [[-0.9547664523124695, -0.8173690438270569, -0.4424106180667877]], 'RWrist': [[-0.3908328115940094, -0.3572131395339966, -0.7523147463798523]]}
    # 0006.jpg
    # pose_dict = {'RHip': [[-63.79127707601772, -15.408233014531419, -4.3987239210315625]], 'RKnee': [[-74.6055683909853, 407.69056379797536, 102.23373625140954]], 'RFoot': [[-36.37154497778616, 835.0309411108543, 207.60318127002196]], 'LHip': [[40.95676630285822, 17.9135008013587, -20.94142856566459]], 'LKnee': [[58.65367640125312, 435.4690857353331, 68.62579554080341]], 'LFoot': [[45.92331197513485, 849.8620616374004, 208.06099830141088]], 'Spine': [[-6.779789997019434, -227.82430556313432, -17.838312957784737]], 'Thorax': [[-5.282020707695334, -474.8442801991864, -66.4967002053047]], 'Neck': [[-20.340757929888866, -550.9824914381373, -118.62287317763571]], 'Head': [[1.373327649619541, -642.3254023769863, -112.51086749986808]], 'LShoulder': [[82.58450246383626, -430.81925842997595, -81.22434542546293]], 'LElbow': [[188.79886594814937, -281.7532965663173, -145.1563583120581]], 'LWrist': [[106.88777210202184, -275.2705807597824, -211.85102384024796]], 'RShoulder': [[-73.60718885644604, -447.8089784171001, -54.322158748297895]], 'RElbow': [[-184.5862015448585, -354.53502036743555, -115.6987076110391]], 'RWrist': [[-106.27265398801853, -399.61408055952273, -218.2636006745538]]}
    # 0026.jpg
    # pose_dict = {'RHip': [[-63.93899937750423, -16.32100187704727, -3.225144746471395]], 'RKnee': [[-75.34402214564915, 407.0745786357551, 104.26152918028298]], 'RFoot': [[-37.165843995253674, 834.9098606503168, 209.3373773754075]], 'LHip': [[41.38394809087055, 18.63311266641018, -21.909337074004636]], 'LKnee': [[58.247592707039985, 436.31429731217304, 66.91923521850283]], 'LFoot': [[47.50621256842544, 850.0282830759193, 206.59769427324832]], 'Spine': [[-5.566828405120423, -227.81839664936732, -17.537662480924467]], 'Thorax': [[-3.662986175324133, -474.9769115388343, -65.80242189194954]], 'Neck': [[-19.948555871161894, -550.985686981019, -117.68654461973783]], 'Head': [[2.4425037343180565, -642.4971749982061, -111.62514470586112]], 'LShoulder': [[84.16788758158619, -431.05629299548485, -82.4861221670476]], 'LElbow': [[188.56937137872046, -283.6541041249486, -150.23767376323593]], 'LWrist': [[106.08505022659998, -278.85206054518954, -217.6320879051738]], 'RShoulder': [[-72.51363073349344, -448.2230458698704, -51.832390399043405]], 'RElbow': [[-183.45918333675618, -357.720347759079, -113.36608731283907]], 'RWrist': [[-107.77676397474039, -403.63058418005085, -216.2423645473698]]}
    # 0246.jpg
    # pose_dict={'RHip': [[7.826590472608073, -2.480084552950922, -57.09823896919513]], 'RKnee': [[-43.238599745729786, 417.03103522273517, 50.17012851390817]], 'RFoot': [[-68.6022639206204, 863.7591847634245, 139.98256217133547]], 'LHip': [[-32.48583054251171, 8.439144951867853, 46.31475242599252]], 'LKnee': [[14.14145416303925, 430.4424865801533, 120.11002733146896]], 'LFoot': [[-49.534215410087526, 854.7545498437698, 210.53125461990473]], 'Spine': [[-15.899189728008803, -222.66247922265046, -46.57628408172814]], 'Thorax': [[-14.173990242402844, -467.3678050693233, -97.78959580014663]], 'Neck': [[11.140800413162227, -553.6311655969068, -118.7691875310895]], 'Head': [[0.20911006430990398, -639.7635342328837, -141.8777506167703]], 'LShoulder': [[-9.281101922707846, -427.269851051971, -54.848198878139016]], 'LElbow': [[7.3770569049980566, -247.02481543303475, 4.719720524132626]], 'LWrist': [[42.33924520510531, -228.70318951070766, -41.81786843270747]], 'RShoulder': [[-3.2068004442910336, -416.9027920838887, -129.1017827044635]], 'RElbow': [[-30.23875035046248, -220.05614684075144, -202.88445066930012]], 'RWrist': [[91.90267561796509, -232.57447448792942, -164.6126269376631]]}
    # ice skettle MPII
    # pose_all = {'RHip': [[26.317533828577965, -13.70869387307573, 22.090564659811037], [25.40693139546324, -18.209893615812664, 35.57571309476914], [45.862204664342826, -13.360812404866703, 3.6409489864142177]], 'RKnee': [[-28.991689599076576, 400.5415817973675, 128.29136461670234], [-16.249243731649262, 404.2383165930811, 134.70679545668526], [6.3133438882286645, 407.10342484059737, 114.80441462345122]], 'RFoot': [[-2.883591650597821, 826.2145698309823, 176.1915149246144], [27.711909201200484, 834.2200917104223, 182.82909935788507], [26.228967890606143, 843.9049176731455, 164.3809590003621]], 'LHip': [[-46.77730891768718, 19.915221639992218, -30.408743371462503], [-40.809199826625694, 24.594961570717544, -43.91901192564856], [-66.76201882027675, 16.58236145173586, -17.000017846852803]], 'LKnee': [[-15.916158727623735, 437.16038393635745, 57.05351626318995], [-35.6245253886169, 440.4755678997431, 56.75368407157152], [-35.48876541147558, 437.2689265246167, 69.22971374832206]], 'LFoot': [[26.189935888093334, 871.1600517981356, 141.20157703276942], [-2.6941684705034956, 875.1545136931303, 138.31656917026604], [-3.137809657216763, 873.8238738344648, 141.9778358065211]], 'Spine': [[1.5272013426539468, -221.63342590492675, -47.374652408187686], [19.75673867425799, -222.44839923480484, -45.06531267608423], [1.752920222004402, -220.72184993272168, -55.72779980236632]], 'Thorax': [[0.856645008268444, -465.02894206240546, -102.45862134366001], [32.56013591935803, -464.81761682151154, -104.12691852647494], [8.263787390520106, -465.1878941418759, -114.71193334462832]], 'Neck': [[-42.53379986385921, -555.5473740073207, -91.02473952038268], [-12.634139438117835, -555.3908016599255, -94.73359785173656], [-13.690179347811375, -557.4999928088131, -93.6948537827887]], 'Head': [[-5.841306254762875, -634.5063235193139, -136.9301974101284], [39.53070551727188, -637.8928695274856, -139.845538519466], [11.778296534559757, -636.1680483076559, -148.48010789515175]], 'LShoulder': [[-26.168527297606442, -401.5973379798063, -145.2494522846101], [5.931308670689646, -396.9121358701772, -157.13363649549038], [-42.82088835762909, -404.1993877205504, -140.61493050308047]], 'LElbow': [[-27.389939488469203, -214.45613539515972, -214.6513705938424], [15.179183576923425, -186.60984215190194, -217.2838422627206], [-69.86456452404215, -224.39899413370068, -153.31933600904972]], 'LWrist': [[-59.30926117902547, -182.78416214526462, -160.70779827785378], [-28.956996728794337, -156.88058047950935, -159.53537509680825], [-80.49325905453733, -210.05551313630735, -94.72552942162613]], 'RShoulder': [[34.23856023543822, -436.35051318013745, -19.39214601643161], [53.68407516165034, -442.6161382177985, -4.647425140606487], [55.262934656581244, -430.3670346878168, -49.95893324918982]], 'RElbow': [[4.502936209929258, -256.93199603793846, -44.05295459553375], [-8.82258760676076, -310.52909779333453, -9.016064212369052], [23.59654322122808, -274.8960647432513, -54.92561367075506]], 'RWrist': [[38.26321692616619, -328.09401052884874, -6.779139675046373], [3.31575780932164, -339.3668287431831, -2.6575457294502343], [51.76675339165002, -336.27576296350776, 2.5113858283235047]]}
    # skipping MPII
    pose_all = {'RHip': [[6.854338162658264, -5.778355363154926, -51.509635255032485], [-18.429137398329047, -14.169909564793503, 29.859786095946994]], 'RKnee': [[-35.00457100255939, 412.2525076121079, 82.01145259021604], [-42.65789502979964, 405.0766320822573, 113.90813317490151]], 'RFoot': [[-40.89930122878142, 856.505498005541, 170.4673955843119], [-6.535983631170683, 835.267248448563, 173.17935218546995]], 'LHip': [[-28.04185086925574, 9.0450051158985, 30.353252538369397], [-9.522493038279025, 21.094605652941894, -37.37791895694937]], 'LKnee': [[8.872904418459335, 430.48124722956464, 109.4048323371724], [18.82918413510685, 438.3236597885442, 62.00556881105694]], 'LFoot': [[-43.8713158793671, 858.3238687298166, 200.59871029468167], [34.05627281943363, 861.7532475031699, 155.39173892539029]], 'Spine': [[-9.74569252371479, -223.7396518371266, -43.44714340813523], [-1.9972887398855308, -225.92626683043036, -33.25308179345963]], 'Thorax': [[-9.424856629035972, -466.3170397912732, -101.09019364556362], [-0.831032633932403, -469.40447597695623, -86.29355066946754]], 'Neck': [[2.579431999792619, -552.3088421808542, -118.90642667480768], [-40.24586251625356, -556.7329477072944, -105.35229926619331]], 'Head': [[11.819133015749218, -639.1562790238229, -146.81776372080665], [-4.393076139445293, -637.9012754985785, -123.15841324960898]], 'LShoulder': [[-2.728948598653042, -423.4673241960269, -73.3159629850696], [17.954784900477186, -409.53977317202083, -125.21351849648607]], 'LElbow': [[1.2046072054301291, -250.22798919089843, -25.514134669783715], [74.61466031332496, -216.13837534049458, -221.43514350287256]], 'LWrist': [[-37.131374724852805, -232.03245617058587, -70.09029489116699], [1.1058848491515008, -174.94301945625995, -203.9077656404012]], 'RShoulder': [[-12.737090130968738, -423.98442964936226, -116.77045096964275], [-9.631235109212838, -445.9725335156557, -18.424970813661872]], 'RElbow': [[-54.38941133897355, -248.16293823786387, -171.16569117189442], [-68.36264092393878, -289.8980281065186, -48.2502034871058]], 'RWrist': [[36.14643779576129, -282.29084631293256, -158.4656002935182], [-18.78593921828973, -325.1926675480794, -66.44484616454446]]}
    pose_dict = {}
    ind = 1
    for i in list(pose_all.keys()):
        pose_dict[i] = [pose_all[i][ind]]

    plot3dPose(pose_dict,'0246.jpg')
